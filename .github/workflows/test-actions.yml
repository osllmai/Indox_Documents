name: Deploy Indox Docs via FTP

on:
  release:
    types: [published]
  push:
    branches:
      - master  # Runs only when code is pushed to master

jobs:
  deploy_docs:
    runs-on: ubuntu-latest

    steps:
      - name: âœ… Enable Debug Logging
        run: echo "ACTIONS_STEP_DEBUG=true" >> $GITHUB_ENV

      - name: âœ… Checkout Repository
        uses: actions/checkout@v3
        with:
          ref: master

      - name: âœ… Install Dependencies
        run: |
          cd indoxDocs/classic
          npm install

      - name: âœ… Ensure `versions.json` Exists
        run: |
          cd indoxDocs/classic
          if [ ! -f versions.json ]; then
            echo '["0.0.1", "0.1", "0.1.1"]' > versions.json
          fi
          cat versions.json

      - name: âœ… Force Rebuild All Versions
        run: |
          cd indoxDocs/classic
          npm run docusaurus clear
          npm run build -- --out-dir build

      - name: âœ… Verify Build Output
        run: ls -la indoxDocs/classic/build/

      - name: ðŸš€ Clean FTP Directory Before Upload
        run: |
          curl -u ${{ secrets.FTP_USERNAME }}:${{ secrets.FTP_PASSWORD }} \
               ftp://${{ secrets.FTP_SERVER }}/docs.osllm.ai/public_html/ \
               -Q "DELE *"

      - name: âœ… Upload to FTP Server (Force Overwrite)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: indoxDocs/classic/build/
          server-dir: docs.osllm.ai/public_html/
          exclude: |
            **/.git*
            **/.github*
            **/node_modules/*
          force: true  # Forces overwriting existing files
          log-level: verbose  # Shows detailed upload logs

