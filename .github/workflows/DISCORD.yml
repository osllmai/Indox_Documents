name: GitHub to Discord & Telegram Notification

on:
  push:
    branches: [ "master" ]
  workflow_dispatch:

jobs:
  notify_discord_telegram:
    runs-on: ubuntu-latest
    steps:

      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch full history to get all tags

      - name: Load README.md Content
        id: load_markdown
        run: |
          echo "üîç DEBUG: Reading README.md..."
          if [[ -f README.md ]]; then
            MARKDOWN_CONTENT=$(head -c 800 README.md)
            echo "‚úÖ README.md content loaded."
          else
            echo "‚ö†Ô∏è WARNING: README.md not found!"
            MARKDOWN_CONTENT="README.md could not be loaded."
          fi

          # Remove Markdown formatting
          PLAIN_TEXT=$(echo "$MARKDOWN_CONTENT" | sed -e 's/#//g' -e 's/\*\*//g' -e 's/`//g')

          # Replace newlines with explicit `\n` for safe processing
          PLAIN_TEXT="${PLAIN_TEXT//$'\n'/\\n}"

          # Store multi-line variable using HERE Document
          cat <<EOF >> "$GITHUB_ENV"
          PLAIN_TEXT=$PLAIN_TEXT
          EOF

          echo "‚úÖ Documentation preview stored safely."

      - name: Prepare Message
        id: prepare_message
        run: |
          cat <<EOF >> "$GITHUB_ENV"
          RELEASE_MESSAGE=üöÄ *New Release: $NEW_TAG*\n\n
          üìÇ Repository: [$REPO](https://github.com/$REPO)\n
          üìú [Documentation](https://github.com/osllmai/Indox_Documents/blob/master/README.md)\n
          üìú *Documentation Update Preview:*\n$PLAIN_TEXT\n
          üè∑Ô∏è Version: $NEW_TAG\n\n
          üîî Stay updated with the latest releases!
          EOF

          echo "‚úÖ Message stored safely."

      - name: Send GitHub Event Notification to Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL_NAME: ${{ secrets.TELEGRAM_CHANNEL_NAME }}
        run: |
          echo "üîç DEBUG: Sending message to Telegram..."
          TELEGRAM_URL="https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage"

          RESPONSE=$(curl -s -G "$TELEGRAM_URL" \
            --data-urlencode "chat_id=$TELEGRAM_CHANNEL_NAME" \
            --data-urlencode "text=$RELEASE_MESSAGE" \
            --data-urlencode "parse_mode=Markdown")

          echo "‚úÖ Telegram Response: $RESPONSE"
